{# Row actions for audit list view - user/request filter buttons #}
{# Usage: include '@DHAuditor/Admin/Audit/_row-actions.html.twig' with {item: item, dataSource: dataSource} #}

{% set diffsWithMeta = item.getDiffs(true) %}
{% set requestId = diffsWithMeta['@context']['request_id']|default(null) %}
{% set hasTimelineSupport = dataSource is defined and dataSource.hasTimelineSupport() %}
{% set createdAt = item.getCreatedAt() %}

<div class="btn-group btn-group-sm" role="group">
    {% if hasTimelineSupport %}
        {% if requestId %}
            <a href="?columnFilters[request_id]={{ requestId|url_encode }}" class="btn btn-outline-info" title="Show all changes from the same HTTP request">
                <span class="material-icons" style="font-size: 1rem;">link</span>
            </a>
        {% endif %}
        {% if item.getUsername() and createdAt %}
            {# Timeline: show ALL entity changes by this user within ±5 minutes #}
            {% set fromTime = createdAt|date_modify('-5 minutes')|date('Y-m-d H:i:s') %}
            {% set toTime = createdAt|date_modify('+5 minutes')|date('Y-m-d H:i:s') %}
            <a href="{{ path('dh_auditor_timeline', {
                   user: item.getUsername(),
                   from: fromTime,
                   to: toTime,
                   anchor_entity: dataSource.getEntityClass(),
                   anchor_id: item.getId()
               }) }}"
               class="btn btn-outline-primary"
               title="Show timeline: all changes by {{ item.getUsername() }} within ±5 minutes">
                <span class="material-icons" style="font-size: 1rem;">schedule</span>
            </a>
        {% elseif item.getUsername() %}
            {# Show all changes by this user (no date filter) #}
            <a href="?columnFilters[blame_user]={{ item.getUsername()|url_encode }}"
               class="btn btn-outline-primary"
               title="Show all changes by {{ item.getUsername() }}">
                <span class="material-icons" style="font-size: 1rem;">person</span>
            </a>
        {% endif %}
    {% endif %}
</div>
