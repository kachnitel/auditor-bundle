{# Inline preview of audit changes for table display #}
{% set diffs = item.getDiffs() %}
{% set diffsWithMeta = item.getDiffs(true) %}
{% set entryId = item.getId() %}
{% set requestId = diffsWithMeta['@context']['request_id']|default(null) %}
{% set hasTimelineSupport = dataSource is defined and dataSource.hasTimelineSupport() %}

{% if diffs is empty %}
    <span class="text-muted">No changes</span>
{% else %}
    {% set diffType = diff_type(diffs) %}

    {# Inline preview #}
    <ul class="list-unstyled d-inline-block mb-0">
        {% if diffType == 'entity_summary' %}
            <twig:K:Audit:DiffInlineEntitySummary :diffs="diffs" />
        {% elseif diffType == 'association_link' %}
            <twig:K:Audit:DiffInlineAssociationLink :diffs="diffs" />
        {% else %}
            <twig:K:Audit:DiffInlineFieldChanges :diffs="diffs" />
        {% endif %}
    </ul>

    {# Show data button and modal #}
    {% set context = diffsWithMeta['@context']|default({}) %}
    {% set hasContextNote = context.note is defined or context.reason is defined %}
    <div class="float-end">
        {% if hasContextNote %}
            <span class="badge bg-light text-dark me-1" title="{{ context.note|default(context.reason) }}">
                <span class="material-icons align-middle" style="font-size: 1rem;">notes</span>
            </span>
        {% endif %}
        <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#auditModal{{ entryId }}">
            Show data
        </button>
    </div>

    <div class="modal fade" id="auditModal{{ entryId }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Audit data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% set context = diffsWithMeta['@context']|default({}) %}
                    {% set contextFields = context|filter((v, k) => k != 'request_id') %}
                    {% if contextFields is not empty %}
                        <div class="alert alert-light border mb-3">
                            {% if context.note is defined %}
                                <div class="mb-2">
                                    <strong>Note:</strong> {{ context.note }}
                                </div>
                            {% endif %}
                            {% if context.reason is defined %}
                                <div class="mb-2">
                                    <strong>Reason:</strong> <span class="badge bg-info">{{ context.reason }}</span>
                                </div>
                            {% endif %}
                            {% for key, value in contextFields %}
                                {% if key not in ['note', 'reason'] %}
                                    <div class="mb-1">
                                        <strong>{{ key }}:</strong> <code>{{ value is iterable ? value|json_encode : value }}</code>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if diffType == 'entity_summary' %}
                        <twig:K:Audit:DiffModalEntitySummary :diffs="diffs" />
                    {% elseif diffType == 'association_link' %}
                        <twig:K:Audit:DiffModalAssociationLink :diffs="diffs" />
                    {% else %}
                        <twig:K:Audit:DiffModalFieldChanges :diffs="diffs" :entryId="entryId" />
                    {% endif %}
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div>
                        {% if hasTimelineSupport %}
                            {% if requestId %}
                                <a href="?columnFilters[request_id]={{ requestId|url_encode }}" class="btn btn-outline-info btn-sm" title="Show all changes from the same HTTP request">
                                    <span class="material-icons align-middle" style="font-size: 1rem;">link</span>
                                    View Related ({{ requestId[:8] }}...)
                                </a>
                            {% endif %}
                            <twig:K:Audit:TimelineLink :item="item" :dataSource="dataSource" showLabel class="btn btn-outline-primary btn-sm ms-1" />
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endif %}
